---
title: "CCDPH GEOGRAPHIC LAYERS"
subtitle: "<u>Processing and development of spatial data layers</u>"
date: "`r format(Sys.time(), '%d %B %Y')`"
format:
  html:
    theme: [journal, "resources/reports.scss"]
    favicon: "https://cookcountypublichealth.org/wp-content/uploads/2018/12/cropped-favicon-32x32.png"
    code-tools: true  
    code-fold: true
    eval: false
    echo: true
    warning: false
    title-block-banner: true
    toc: true
    toc-depth: 3
    toc-location: left
    include-in-header: "resources/header.html"
    reference-location: document
    tbl-cap-location: bottom
    fig-cap-location: top
    fig-height: 2.75 # 2.75
    fontsize: 0.9em # 0.9
    interlinespace: -0.75em
    embed-resources: true
bibliography: "resources/references.bib"
editor_options: 
  chunk_output_type: console
---

```{r}
#| eval: true

library(dplyr)
library(dbplyr)
library(tidyverse)
library(DT)
library(data.table)
library(sf)
library(sp)
library(leaflet)
library(leaflet.providers)
library(leaflet.extras)
library(keyring)
library(DBI)
library(odbc)
library(spData)
library(tigris)
library(units)

# add functions for reading/writing spatial data from/to database
source("https://raw.githubusercontent.com/Cook-County-Department-of-Public-Health/ccdph-functions/master/spatial-database-functions.R")
```

# Geography {.unnumbered}

## CCDPH jurisdiction
Cook County Department of Public Health (CCDPH) was established in 1945 and is the state-certified public health agency for most of suburban Cook County (SCC). CCDPH’s jurisdiction is within the largely urban Bellwood health region, one of [seven health regions within the state of Illinois](https://dph.illinois.gov/contact-us/regional-health-departments.html). CCDPH has an approximate area of 693 square miles and serves 2.3 million residents (Census Bureau 2020).

The code below is used to create and write the *ccdph_boundary* table to the *inter-spatial* database.

```{r}
#| label: CCDPH jurisdiction boundary
#| eval: false

# download latest data from US Census TIGER/Line files
IL_Places_geom <- places(c("IL"), cb=TRUE, class="sf")
IL_Counties_geom <- counties(c("IL"), cb=TRUE, class="sf")
IL_MCDs_geom <- county_subdivisions(c("IL"), cb=TRUE, class="sf")
IL_Places_geom <- st_transform(IL_Places_geom, crs = 3435)
IL_Counties_geom <- st_transform(IL_Counties_geom, crs = 3435)
IL_MCDs_geom <- st_transform(IL_MCDs_geom, crs = 3435)

# Select out of jurisdiction (OOJ) places
ooj_places <- IL_Places_geom %>% 
  filter(#NAME=="Chicago" |
           # NAME=="Bedford Park" |
           # NAME=="Stickney" |
           # NAME=="Burbank" |
           # NAME=="Forest View" |
           NAME=="Evanston" | 
           NAME=="Oak Park" | 
           NAME=="Skokie"
           ) %>%
  select(geoid_place = GEOID,
         name_place = NAME)

# Select Minor Civil Divisions (MCD) Stickney Township, Cook County
ooj_mcds <- IL_MCDs_geom %>% 
  filter(COUNTYFP=="031" &
           (NAME=="Stickney" |
           NAME=="Chicago")) %>%
  select(name_mcd = NAME,
         geoid_mcd = GEOID)

# Create mask from union of OOJ places and Minor Civil Divisions --------
ooj_mask <-  ooj_places %>% 
  st_union(ooj_mcds, by_feature = FALSE) %>% 
  st_union(by_feature = FALSE) %>% st_as_sf()

# Select Cook County boundary
cc_boundary <- IL_Counties_geom %>% 
  filter(STATEFP=="17" & COUNTYFP=="031") %>%
  select(geoid_county = GEOID,
         name_county = NAME)

# Use mask to clip from Cook County and produce final CCDPH boundary
ccdph_boundary <- st_difference(cc_boundary,
                                        ooj_mask) %>%
  mutate(name_ccdph="CCDPH boundary") %>%
  select(name_ccdph) %>%
  mutate(area_sqmi = st_area(geometry),
         area_sqmi = set_units(area_sqmi, m^2),
         area_sqmi = set_units(area_sqmi, mi^2))

# write simple feature layer to database
fx_write_spatial_layer_to_database(
  sf_layer_name = ccdph_boundary,
  schema_name = "ref",
  db_table_name = "ccdph_boundary",
  crs_id = 3435)

```

## Spatial data layers in inter-spatial database
The Epidemiology and Communicable Disease units manage code used to produce the CCDPH jurisdiction boundary and other geographic layers from secondary data sources.  The same layers are also stored in the *inter-spatial* database using native SQL Server geometry on the CCDPH SQL Server. All spatial data in the database are stored in the [EPSG 3435](https://epsg.io/3435) coordinate reference system (CRS).

```{r}
#| label: fig-layers_datadictionary
#| eval: true
#| echo: false
#| fig-cap: Illinois Counties (counties_illinois) Data Dictionary

con_inter_spatial <- dbConnect(odbc::odbc(),
                               Driver   = "SQL Server",
                               Server   = key_get("ccdph_sql_server"),
                               Database = "inter-spatial")

tbl(
  src = con_inter_spatial,
  from = in_schema("ref",
                   "counties_illinois")) %>%
  select(-geom) %>%
  collect() %>%
  datatable(class = 'cell-border stripe',
            rownames = FALSE,
            options = list(pageLength = 10)) %>%
  formatRound(columns=c(3:5), digits=1) %>%
  formatStyle(columns = c(1:5),
              fontSize = '90%') %>%
  formatStyle(columns = c(3:5),
              textAlign = 'right')
```


::: {.callout-note collapse="false"}
## Spatial data-related GitHub repositories

The GIS layer creation code and zipped versions of output geographic shapefiles are available via the [cchdph-shapefiles](https://github.com/Cook-County-Department-of-Public-Health/ccdph-shapefiles) GitHub repository. R code for reading and writing GIS layers from/to the *inter-spatial* SQL Server is available in the [spatial-database-functions.R](https://github.com/Cook-County-Department-of-Public-Health/ccdph-functions/blob/master/spatial-database-functions.R) script in the [ccdph-functions](https://github.com/Cook-County-Department-of-Public-Health/ccdph-functions) GitHub repository.
:::

## Interactive map of CCDPH-related geographies

@fig-geographies provides an interactive display of the most commonly used geographic units or boundaries used by Epidemiology Unit staff. 

```{r}
#| label: fig-geographies
#| fig-cap: CCDPH-Related Geographies
#| eval: true
#| echo: true

# import GIS layers from inter-spatial
ccdph_boundary <- fx_read_spatial_layer_fr_database(db_table_name = "ccdph_boundary", crs_id = 4326)
scc_boundary <- fx_read_spatial_layer_fr_database(db_table_name = "scc_boundary", crs_id = 4326)
counties_illinois <- fx_read_spatial_layer_fr_database(db_table_name = "counties_illinois", crs_id = 4326) %>% dplyr::filter(geoid_county=="17031")
munis_cook_county_clipped <- fx_read_spatial_layer_fr_database(db_table_name = "munis_cook_county_clipped", crs_id = 4326)
ccdph_districts <- fx_read_spatial_layer_fr_database(db_table_name = "ccdph_district_boundaries_muni", crs_id = 4326)

# labels_districts <- sprintf(
#   "<strong>%s</strong><br/>
#   %s mi<sup>2</sup>",
#   paste0(studyarea_counties_acs$name_county," County"),
#   paste0("Area: ", prettyNum(studyarea_counties_acs$sqmi_county,digits=2, big.mark = ","))) %>% lapply(htmltools::HTML)
# 
# labels_scc <- sprintf(
#   "<strong>%s</strong><br/>
#   %s mi<sup>2</sup>",
#   paste0(studyarea_counties_acs$name_county," County"),
#   paste0("Area: ", prettyNum(studyarea_counties_acs$sqmi_county,digits=2, big.mark = ","))) %>% lapply(htmltools::HTML)
# 
# labels_ccdph <- sprintf(
#   "<strong>%s</strong><br/>
#   %s mi<sup>2</sup>",
#   paste0(studyarea_counties_acs$name_county," County"),
#   paste0("Area: ", prettyNum(studyarea_counties_acs$sqmi_county,digits=2, big.mark = ","))) %>% lapply(htmltools::HTML)
# 
# labels_muni <- sprintf(
#   "<strong>%s</strong><br/>
#   %s mi<sup>2</sup>",
#   paste0(studyarea_counties_acs$name_county," County"),
#   paste0("Area: ", prettyNum(studyarea_counties_acs$sqmi_county,digits=2, big.mark = ","))) %>% lapply(htmltools::HTML)

leaflet() %>%
  addProviderTiles("Esri.WorldImagery", group = "Imagery") %>%
  addProviderTiles(providers$CartoDB.Positron, group = "Basemap") %>%
  addPolygons(
    group = "Cook County",
    data = counties_illinois,
    fillColor = "orange",
    weight = 2,
    opacity = 0.5,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.7
  ) %>%
  addPolygons(
    group = "CCDPH",
    data = ccdph_boundary,
    weight = 2,
    opacity = 0.5,
    color = "white",
    dashArray = "3",
    fillColor = "darkblue",
    fillOpacity = 0.7
  ) %>%
  addPolygons(
    group = "SCC",
    data = scc_boundary,
    weight = 2,
    opacity = 0.5,
    color = "white",
    dashArray = "3",
    fillColor = "lightblue",
    fillOpacity = 0.7
  ) %>%
  addPolygons(
    group = "Munis",
    data = munis_cook_county_clipped,
    weight = 2,
    opacity = 0.5,
    color = "white",
    dashArray = "1",
    fillColor = "lightyellow",
    fillOpacity = 0.7
  ) %>%
  addPolygons(
    group = "Districts",
    data = ccdph_districts %>% dplyr::filter(name_district !=
                                               "OOJ"),
    weight = 2,
    opacity = 0.5,
    color = "black",
    dashArray = "1",
    fillColor = NULL,
    fillOpacity = 0
  ) %>%
  addLayersControl(
    overlayGroups = c("Districts",
                      "Cook County",
                      "CCDPH",
                      "SCC",
                      "Munis"),
    baseGroups = c("Basemap",
               "Imagery"),
    options = layersControlOptions(collapsed = FALSE),
    position = c("topright")
  ) %>%
  hideGroup(c("CCDPH", "SCC", "Munis", "Districts","Imagery")) %>%
  addFullscreenControl()

```

### Cook County (aka Bellwood health region)
Cook County is one of Illinois' 102 counties and is the largest county in Illinois in terms of population, comprising over 40 percent of the total population of Illinois. The Bellwood health region, which shares the same boundary as Cook County, is the smallest of the state’s health regions in terms of area  (1,635 square miles), although it has the most residents (5.2 million in 2020) and comprises over 40 percent of the total population of Illinois.

CCDPH is one of six local health departments (LHDs) within Cook County. The other five are the [Chicago Department of Public Health](https://www.chicago.gov/city/en/depts/cdph.html), the [City of Evanston Department of Health and Human Services](https://www.cityofevanston.org/government/departments/health-human-services), the [Village of Oak Park Department of Public Health](https://www.oak-park.us/village-services/department-public-health), the [Stickney Township Public Health District](http://stickneypublichealthdistrict.org/) and the [Village of Skokie Health Department](https://www.skokie.org/158/Health). The [latest contact information for local health departments in Illinois](https://idph.illinois.gov/IDPHPrograms/v_LHDDirectory/Show-V-LHDDirectory-Public.aspx?RegionServed=7) can be found on the Illinois Department of Public Health website.

The code below is used to create and write the *counties_illinois* table to the *inter-spatial* database. @fig-counties_datatable lists the attribute data within the *counties_illinois* table.

```{r}
#| label: Illinois counties
#| eval: false

# download latest counties data from US Census TIGER/Line data
counties_il <- counties(state="17", cb=TRUE)

# reformat data, standardize column names
counties_il <- counties_il %>%
  st_transform(3435) %>%
  st_as_sf() %>%
  select(geoid_county = GEOID,
         name_county = NAME,
         area_land = ALAND,
         area_water = AWATER) %>%
  mutate(area_land = set_units(area_land,m^2),
         area_water = set_units(area_water,m^2),
         area_land_sqmi = set_units(area_land, mi^2),
         area_water_sqmi = set_units(area_water,mi^2),
         area_sqmi = area_land_sqmi + area_water_sqmi) %>%
  select(-c(area_land,area_water))

# write counties_illinois layer to inter-spatial database

fx_write_spatial_layer_to_database(
  sf_layer_name = counties_il,
  schema_name = "ref",
  db_table_name = "counties_illinois",
  crs_id = 3435)

```

```{r}
#| label: fig-counties_datatable
#| eval: true
#| echo: false
#| fig-cap: Illinois Counties (counties_illinois) Data Dictionary

con_inter_spatial <- dbConnect(odbc::odbc(),
                               Driver   = "SQL Server",
                               Server   = key_get("ccdph_sql_server"),
                               Database = "inter-spatial")

tbl(
  src = con_inter_spatial,
  from = in_schema("ref",
                   "counties_illinois")) %>%
  select(-geom) %>%
  collect() %>%
  datatable(class = 'cell-border stripe',
            rownames = FALSE,
            options = list(pageLength = 10)) %>%
  formatRound(columns=c(3:5), digits=1) %>%
  formatStyle(columns = c(1:5),
              fontSize = '90%') %>%
  formatStyle(columns = c(3:5),
              textAlign = 'right')
```

### Suburban Cook County (SCC)

Suburban Cook County (SCC) refers to the entire area of Cook County excluding the city of Chicago. It has an area of approximately 727.5 square miles. Suburban Cook County includes the CCDPH jurisdiction combined with areas of the four other suburban Cook County local health departments: the [City of Evanston Department of Health and Human Services](https://www.cityofevanston.org/government/departments/health-human-services), the [Village of Oak Park Department of Public Health](https://www.oak-park.us/village-services/department-public-health), the [Stickney Township Public Health District](http://stickneypublichealthdistrict.org/) and the [Village of Skokie Health Department](https://www.skokie.org/158/Health).

The code below is used to create and write the *scc_boundary* table to the *inter-spatial* database.

```{r}
#| label: Suburban Cook County boundary
#| eval: false

# download latest data from US Census TIGER/Line files
IL_Places_geom <- places(c("IL"), cb=TRUE, class="sf")
IL_Counties_geom <- counties(c("IL"), cb=TRUE, class="sf")

# Filter city of Chicago boundary out of Illinois places
chicago_boundary <- IL_Places_geom %>% 
  filter(NAME=="Chicago") %>%
  select(geoid_place = GEOID,
         name_place = NAME)

# Select Cook County boundary
cc_boundary <- IL_Counties_geom %>% 
  filter(STATEFP=="17" & COUNTYFP=="031") %>%
  select(geoid_county = GEOID,
         name_county = NAME)

# Use mask to clip from Cook County and produce SCC boundary
scc_boundary <- st_difference(cc_boundary,
                                        chicago_boundary) %>%
  st_as_sf() %>%
  st_make_valid() %>%
  mutate(name_scc="SCC boundary") %>%
  select(name_scc) %>%
  mutate(area_sqmi = st_area(geometry),
         area_sqmi = set_units(area_sqmi, m^2),
         area_sqmi = set_units(area_sqmi, mi^2))

# write simple feature layer to database
fx_write_spatial_layer_to_database(
  sf_layer_name = scc_boundary,
  schema_name = "ref",
  db_table_name = "scc_boundary",
  crs_id = 3435)

```

### CCDPH health districts

There are four health districts within CCDPH's jurisdiction: north, west, southwest and south. These four districts are used by CCDPH to account for and evaluate for variations in social and demographic patterns across its jurisdiction, and to enumerate and report the incidence and prevalence of disease and other health indicators. It is often useful to include health district boundaries on jurisdiction-wide maps. The Epidemiology and Communicable Disease Units maintains two versions of health district boundaries; one that aligns better with municipal boundaries and another which aligns with census tract boundaries.

#### District boundaries for municipality-level mapping

Health district boundaries can be delineated using municipal and census tract boundaries. When creating maps using municipal-level data, it is recommended to use boundaries. The municipal boundaries and another which aligns with census tract boundaries. The code below is used to create and write the *ccdph_district_boundaries_muni* table to the *inter-spatial* database.

```{r}
# download latest data from ccdph-shapefiles GitHub 
ccdph_district_boundaries_muni <- st_read("C:/Users/christopher.smith/OneDrive - Cook County Health/git_repos/justenvirons/ccdph-shapefiles/epsg-3435-illinois-stateplane-east/ccdph_districts_boundaries_muni_epsg3435.shp") %>%
  mutate(name_district = if_else(district=="Outside", "OOJ", district),
         area_sqmi = st_area(geometry),
         area_sqmi = set_units(area_sqmi, m^2),
         area_sqmi = set_units(area_sqmi, mi^2))

# write simple feature layer to database
fx_write_spatial_layer_to_database(
  sf_layer_name = ccdph_district_boundaries_muni,
  schema_name = "ref",
  db_table_name = "ccdph_district_boundaries_muni",
  crs_id = 3435)

```

#### District boundaries for census tract-level mapping

The code below is used to create and write the *ccdph_district_boundaries_tract* table to the *inter-spatial* database.

```{r}
# download latest data from ccdph-shapefiles GitHub 
ccdph_district_boundaries_tract <- st_read("C:/Users/christopher.smith/OneDrive - Cook County Health/git_repos/justenvirons/ccdph-shapefiles/epsg-3435-illinois-stateplane-east/ccdph_districts_boundaries_tracts_epsg3435.shp") %>%
  select(-sqmi) %>%
  rename(num_tracts_2020 = tracts,
         name_district = district) %>%
  mutate(name_district = str_to_title(name_district),
         name_district = if_else(name_district=="Outside", "OOJ", name_district),
         area_sqmi = st_area(geometry),
         area_sqmi = set_units(area_sqmi, m^2),
         area_sqmi = set_units(area_sqmi, mi^2))

# write simple feature layer to database
fx_write_spatial_layer_to_database(
  sf_layer_name = ccdph_district_boundaries_tract,
  schema_name = "ref",
  db_table_name = "ccdph_district_boundaries_tract",
  crs_id = 3435)

```

### CCDPH municipalities

CCDPH’s jurisdiction includes 120 municipalities, 114 in their entirety and portions of six others. The unincorporated area population (i.e., the population residing outside of the 120 incorporated municipalities) within CCDPH is estimated to be about 104,874, or 4.6 percent of the jurisdiction’s total. 
#### Municipalities in Cook County

The code below is used to create and write the *munis_cook_county* table to the *inter-spatial* database.

```{r}
#| label: municipalities in Cook County

# download latest data from US Census TIGER/Line files
places_il <- places(state = "17", cb=TRUE) %>% 
  st_as_sf() %>%
  st_transform(crs = 3435)

# download latest data from ccdph-shapefiles GitHub 
munis_cook_county <- st_read("C:/Users/christopher.smith/OneDrive - Cook County Health/git_repos/justenvirons/ccdph-shapefiles/epsg-3435-illinois-stateplane-east/ccdph-cook-county-munis.shp") %>%
  st_drop_geometry() %>%
  drop_na(muni_name) %>%
  left_join(places_il %>% 
              select(NAME,geoid_place = GEOID,area_land = ALAND,area_water= AWATER), 
            by=c("muni_name"="NAME")) %>%
  st_as_sf() %>%
  mutate(area_land = set_units(area_land,m^2),
         area_water = set_units(area_water,m^2),
         area_land_sqmi = set_units(area_land, mi^2),
         area_water_sqmi = set_units(area_water,mi^2),
         area_sqmi = area_land_sqmi + area_water_sqmi,
         location = case_when(district=="OOJ" & muni_name!="Chicago" ~ "SCC",
                              district=="OOJ" & muni_name=="Chicago" ~ "Chicago",
                              district != "OOJ" ~ "CCDPH")) %>%
  select(name_place = muni_name,
         geoid_place,
         location,
         district,
         partial_ccdph = partial,
         exclude,
         area_land_sqmi,
         area_water_sqmi,
         area_sqmi) %>%
  arrange(name_place) %>%
  st_make_valid()

# write simple feature layer to database
fx_write_spatial_layer_to_database(
  sf_layer_name = munis_cook_county,
  db_table_name = "munis_cook_county")

```

#### Municipalities in Cook County (clipped)

The code below is used to create and write the *munis_cook_county_clipped* table to the *inter-spatial* database.

```{r}
# clip munis_cook_county data in ArcGIS Pro 

munis_cook_county_clipped <- st_read("C:/Users/christopher.smith/OneDrive - Cook County Health/git_repos/justenvirons/ccdph-jurisdictions/layers/munis_cook_county_clipped.shp") %>%
  select(geoid_place = geoid_plac) %>%
  left_join(munis_cook_county %>% st_drop_geometry(), by="geoid_place")

fx_write_spatial_layer_to_database(
  sf_layer_name = munis_cook_county_clipped,
  db_table_name = "munis_cook_county_clipped")
```


### USPS zip codes and zip code tabulation areas (ZCTAs)

#### ZCTAs in Cook County
Zip code tabulation areas (ZCTAs) in Cook County.

```{r}
#| label: ZCTas in Cook County

# download latest data from US Census TIGER/Line files 
# (2020 data not stratified by state)
zctas_us <- zctas(cb=TRUE, year=2020) %>%
  st_drop_geometry() %>%
  select(geoid_zcta = GEOID20,
         area_land = ALAND20,
         area_water = AWATER20)

# download latest data from ccdph-shapefiles GitHub 
zctas_cook_county <- st_read("C:/Users/christopher.smith/OneDrive - Cook County Health/git_repos/justenvirons/ccdph-shapefiles/epsg-3435-illinois-stateplane-east/cook_county_zctas_epsg3435.shp") %>%
  select(geoid_zcta = zcta,
         primary_city = prmry_c,
         partial_ccdph = prtl_pp,
         percent_ccdph = prcnt_d,
         notes) %>%
  drop_na(geoid_zcta) %>%
  left_join(zctas_us, by="geoid_zcta") %>%
  st_as_sf() %>%
  mutate(area_land = set_units(area_land,m^2),
         area_water = set_units(area_water,m^2),
         area_land_sqmi = set_units(area_land, mi^2),
         area_water_sqmi = set_units(area_water,mi^2),
         area_sqmi = area_land_sqmi + area_water_sqmi) %>%
  select(-c(area_land, area_water)) %>%
  st_transform(crs = 3435) %>%
  st_make_valid()

# write simple feature layer to database
fx_write_spatial_layer_to_database(
  sf_layer_name = zctas_cook_county,
  schema_name = "ref",
  db_table_name = "zctas_cook_county",
  crs_id = 3435)

```

#### ZCTAs in Cook County (clipped)
```{r}
# clip zctas_cook_county data in ArcGIS Pro 

zctas_cook_county_clipped <- st_read("C:/Users/christopher.smith/OneDrive - Cook County Health/git_repos/justenvirons/ccdph-jurisdictions/layers/zctas_cook_county_clipped.shp") %>%
  select(geoid_zcta) %>%
  left_join(zctas_cook_county %>% st_drop_geometry(), by="geoid_zcta")

fx_write_spatial_layer_to_database(
  sf_layer_name = zctas_cook_county_clipped,
  db_table_name = "zctas_cook_county_clipped")
```


### Census tracts


Below is code that was used to process CCDPH-relevant cartographic boundary shapefiles made available in the CCDPH *inter-spatial* database. The geographic data represent both political and analytical boundaries derived from the US Census Bureau via its [TIGER/Line](https://www.census.gov/geographies/mapping-files/time-series/geo/tiger-line-file.html) program. By default, census-derived shapes are generalized to 1:500K. Set "cb=FALSE" to acquire more detailed TIGER/Line files.

#### 2010 census tracts in Cook County

```{r}
# download latest data from US Census TIGER/Line files
tracts_2010_cook_county_census <- tracts(state="17", county="031", cb=TRUE, year=2010) %>%
  st_drop_geometry() %>%
  mutate(geoid_tract_2010 = paste0(STATE,COUNTY,TRACT),
         name_tract_2010 = NAME,
         area_sqmi = set_units(CENSUSAREA, mi^2)) %>%
  select(geoid_tract_2010,
         name_tract_2010,
         area_sqmi)

# download latest data from ccdph-shapefiles GitHub 
tracts_2010_cook_county <- st_read("C:/Users/christopher.smith/OneDrive - Cook County Health/git_repos/justenvirons/ccdph-shapefiles/epsg-3435-illinois-stateplane-east/cc_tracts_2010_epsg3435.shp") %>%
  select(-sqmi) %>%
  rename(geoid_tract_2010 = fips,
         name_district = district) %>%
  mutate(name_district = str_to_title(name_district),
         name_district = if_else(name_district=="Outside", "OOJ", name_district),
         location = str_to_upper(location),
         location = if_else(location=="CHICAGO","Chicago",location)) %>%
  left_join(tracts_2010_cook_county_census, by="geoid_tract_2010")

# write simple feature layer to database
fx_write_spatial_layer_to_database(
  sf_layer_name = tracts_2010_cook_county,
  schema_name = "ref",
  db_table_name = "tracts_2010_cook_county",
  crs_id = 3435)

```

#### 2020 census tracts in Cook County

```{r}
# download latest data from US Census TIGER/Line files
tracts_2020_cook_county_census <- tracts(state="17", county="031", cb=TRUE, year=2020) %>%
  st_drop_geometry() %>%
  select(geoid_tract_2020 = GEOID,
         name_tract_2020 = NAME,
         area_land = ALAND,
         area_water = AWATER) %>%
  mutate(area_land = set_units(area_land,m^2),
         area_water = set_units(area_water,m^2),
         area_land_sqmi = set_units(area_land, mi^2),
         area_water_sqmi = set_units(area_water,mi^2),
         area_sqmi = area_land_sqmi + area_water_sqmi) %>%
  select(geoid_tract_2020,
         name_tract_2020,
         area_land_sqmi:area_sqmi)

# download latest data from ccdph-shapefiles GitHub 
tracts_2020_cook_county <- st_read("C:/Users/christopher.smith/OneDrive - Cook County Health/git_repos/justenvirons/ccdph-shapefiles/epsg-3435-illinois-stateplane-east/cc_tracts_2020_epsg3435.shp") %>%
  select(-sqmi) %>%
  rename(geoid_tract_2020 = fips,
         name_district = district) %>%
  mutate(name_district = str_to_title(name_district),
         name_district = if_else(name_district=="Outside", "OOJ", name_district),
         location = str_to_upper(location),
         location = if_else(location=="CHICAGO","Chicago",location)) %>%
  left_join(tracts_2020_cook_county_census, by="geoid_tract_2020")

# write simple feature layer to database
fx_write_spatial_layer_to_database(
  sf_layer_name = tracts_2020_cook_county,
  schema_name = "ref",
  db_table_name = "tracts_2020_cook_county",
  crs_id = 3435)

```
